name: Test

on:
  workflow_dispatch: 
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  test-ios:
    runs-on: macos-14
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show Xcode + Simulator Info
        run: |
          xcodebuild -version
          xcrun simctl list
          
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Fix SwiftLint config permissions
        run: chmod 644 .swiftlint.yml
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -scheme "LittleLemon" \
            -destination 'generic/platform=iOS Simulator' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult
      
      - name: Cache Homebrew Tools
        id: cache-brew-tools
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/xcresultparser
            /opt/homebrew/Cellar/xcparse
            /opt/homebrew/bin/xcresultparser
            /opt/homebrew/bin/xcparse
          key: ${{ runner.os }}-brew-tools-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-tools-
      
      - name: Install Tools
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        if: (success() || failure()) && steps.cache-brew-tools.outputs.cache-hit != 'true'
        run: |
          brew install xcresultparser
          brew install chargepoint/xcparse/xcparse
      
      - name: Convert xcresult to JUnit
        if: success() || failure()
        run: |
          if [ -d "TestResults.xcresult" ]; then
            xcresultparser -o junit TestResults.xcresult > junit.xml
          fi
      
      - name: Extract Attachments
        if: success() || failure()
        run: |
          if [ -d "TestResults.xcresult" ]; then
             xcparse attachments TestResults.xcresult TestAttachments
          fi
      
      - name: Sanitize Attachment Filenames
        if: success() || failure()
        run: |
          if [ -d "TestAttachments" ]; then
              find TestAttachments -type f -print0 | while IFS= read -r -d '' file; do
                  filename=$(basename "$file")
                  clean_filename=$(echo "$filename" | tr -d '":<>|*?\r\n')
                  if [ "$filename" != "$clean_filename" ]; then
                      mv "$file" "$(dirname "$file")/$clean_filename"
                  fi
              done
          fi
      
      - name: Upload Test Attachments
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-attachments
          path: TestAttachments
      
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          report_paths: 'junit*.xml'